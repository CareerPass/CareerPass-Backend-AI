# -*- coding: utf-8 -*-
"""
Resume Feedback API
ì‚¬ìš©ì -> ì´ë ¥ì„œ ì…ë ¥ -> OpenAI í”¼ë“œë°± ìƒì„± -> RDS ì €ì¥
"""

import os
import pymysql
from typing import List
from datetime import datetime
from fastapi import FastAPI, HTTPException, APIRouter
from pydantic import BaseModel, Field
from openai import OpenAI
from dotenv import load_dotenv # í™˜ê²½ ë³€ìˆ˜ ë¡œë“œë¥¼ ìœ„í•´ ì¶”ê°€

# í™˜ê²½ ë³€ìˆ˜ ë¡œë“œ (HEAD ë¸Œëœì¹˜ì—ì„œ ê°€ì ¸ì˜´)
load_dotenv()

# FastAPI ë¼ìš°í„° ì„¤ì • (ëª©í‘œ ë¸Œëœì¹˜ êµ¬ì¡° ì±„íƒ)
resume_router = APIRouter()

# í™˜ê²½ë³€ìˆ˜ ë° OpenAI í´ë¼ì´ì–¸íŠ¸ ì´ˆê¸°í™” 
RESUME_KEY = os.getenv("RESUME_OPENAI_KEY")
try:
    client = OpenAI(api_key=RESUME_KEY)
    print("Resume Router OpenAI í´ë¼ì´ì–¸íŠ¸ ì´ˆê¸°í™” ì™„ë£Œ.")
except Exception:
    print("OpenAI API Keyê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ë¶„ì„ì€ Mock ëª¨ë“œë¡œ ì‘ë™í•©ë‹ˆë‹¤.")
    client = None

# RDS DB ì—°ê²° ì •ë³´ ë¡œë“œ
DB_HOST = os.getenv("RDS_DB_HOST")
DB_USER = os.getenv("RDS_DB_USER")
DB_PASSWORD = os.getenv("RDS_DB_PASSWORD")
DB_NAME = os.getenv("RDS_DB_NAME")

# ì‹¤ ë°°í¬ í™˜ê²½ìœ¼ë¡œ AWS RDS MYSQL ì‚¬ìš©
try:
    db = pymysql.connect(
        host=DB_HOST,
        user=DB_USER,
        password=DB_PASSWORD,
        database=DB_NAME,
        charset="utf8mb4"
    )

    cursor = db.cursor()

    # DB í…Œì´ë¸” ìƒì„± í™•ì¸
    cursor.execute("""
    CREATE TABLE IF NOT EXISTS resume_feedback (
        id INT AUTO_INCREMENT PRIMARY KEY,
        user_id INT NOT NULL,
        resume_text TEXT,
        feedback_text TEXT,
        created_at DATETIME
    );
    """)

    db.commit()
    
except Exception as e:
    print(f"Database Connection Error: {e}")
    db = None
    cursor = None


# ìš”ì²­ + ì‘ë‹µ ëª¨ë¸
class ResumeInput(BaseModel):
    userId: int
    resumeContent: str
    
# ì„œë²„ê°€ í´ë¼ì´ì–¸íŠ¸í•œí…Œë¡œ
class FeedbackResponse(BaseModel):
    feedback: str
    userId: int


# í”„ë¡¬í”„íŠ¸
system_message = """
#ì´ë ¥ì„œë¥¼ í”¼ë“œë°±í•˜ëŠ” ì—ì´ì „íŠ¸ ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸ 

##ì—­í•  ì •ì˜
ë‹¹ì‹ ì€ ì·¨ì—… ì¤€ë¹„ ëŒ€í•™ìƒì„ ìœ„í•œ ì´ëµì„œ ì»¨ì„¤í„´íŠ¸ ì „ë¬¸ê°€ì…ë‹ˆë‹¤.
ì±„ìš© ë‹´ë‹¹ìì˜ ê´€ì ì—ì„œ ì´ë ¥ì„œë¥¼ ë¶„ì„í•˜ê³ , 
ì„œë¥˜ ì „í˜• í†µê³¼ìœ¨ì„ ë†’ì´ê¸° ìœ„í•œ êµ¬ì²´ì ì´ê³  ì‹¤í–‰ ê°€ëŠ¥í•œ í”¼ë“œë°±ì„ ì œê³µí•´ì•¼í•©ë‹ˆë‹¤.

##ì£¼ìš” ëª©í‘œ
- ì´ë ¥ì„œ ìŠ¤í¬ë¦¬ë‹(1ì°¨ ì„œë¥˜ íƒˆë½)ì„ ë°©ì§€í•˜ëŠ” ê²ƒì´ ìµœìš°ì„ ì ì¸ ëª©í‘œ
-ì±„ìš© ë‹´ë‹¹ìê°€ 6ì´ˆ ì´ë‚´ì— í•µì‹¬ ì—­ëŸ‰ì„ íŒŒì•…í•  ìˆ˜ ìˆë„ë¡ ê°œì„  ë°©í–¥ ì œì‹œ
-ATS(Applicant Tracking System) í†µê³¼ë¥¼ ìœ„í•œ ìµœì í™” ì¡°ì–¸

##ë¶„ì„ í”„ë ˆì„ì›Œí¬

###1ë‹¨ê³„ : ì „ì²´ êµ¬ì¡° í‰ê°€
ë‹¤ìŒ í•­ëª©ì„ ì²´í¬ë¦¬ìŠ¤íŠ¸ë¡œ í™•ì¸ :
- [ ] ê¸°ë³¸ ì •ë³´(ì´ë¦„, ì—°ë½ì²˜, ì´ë©”ì¼, ë§í¬)
- [ ] í•™ë ¥ ì‚¬í•­
- [ ] ê²½í—˜ ë° í™œë™(ì¸í„´, í”„ë¡œì íŠ¸, ìˆ˜ìƒ, ëŒ€ì™¸í™œë™ ë“±)
- [ ] ê¸°ìˆ  ìŠ¤íƒ ë° ì—­ëŸ‰
- [ ] ìê²©ì¦ ë° ìˆ˜ìƒ ê²½ë ¥(í•´ë‹¹ ì‹œ)
- [ ] 1~2í˜ì´ì§€ ë¶„ëŸ‰ ì¤€ìˆ˜ ì—¬ë¶€

###2ë‹¨ê³„ : ì¹˜ëª…ì  ì˜¤ë¥˜ ì‹ë³„(ìµœìš°ì„  ê°œì„  ì‚¬í•­)
ë‹¤ìŒ ë¬¸ì œê°€ ìˆë‹¤ë©´ **ì¦‰ì‹œ ìˆ˜ì • í•„ìš”**ë¡œ í‘œì‹œ :
- ì˜¤íƒ€, ë§ì¶¤ë²•, ë¬¸ë²• ì˜¤ë¥˜
- ì—°ë½ì²˜ ì •ë³´ ëˆ„ë½ ë˜ëŠ” ì˜¤ë¥˜
- ë¹„ì „ë¬¸ì ì¸ ì´ë©”ì¼ ì£¼ì†Œ
- ê³¼ë„í•œ ë¶„ëŸ‰ (3í˜ì´ì§€ ì´ìƒ)
- ì‚¬ì§„ í¬í•¨ ì—¬ë¶€ (ì±„ìš© ê³µê³ ì—ì„œ ìš”êµ¬í•˜ì§€ ì•ŠëŠ” ê²½ìš°)
- ì£¼ë¯¼ë“±ë¡ë²ˆí˜¸ ë“±ì˜ ë¯¼ê° ì •ë³´ ë…¸ì¶œ

###3ë‹¨ê³„ : ë‚´ìš© í’ˆì§ˆ ë¶„ì„
ê° ê²½í—˜/í”„ë¡œì íŠ¸ í•­ë³µì— ëŒ€í•´ : 
- **STAR ê¸°ë²•** ì ìš© ì—¬ë¶€ (Situation-Task-Action-Result)
- **ì •ëŸ‰ì  ì„±ê³¼** í¬í•¨ ì—¬ë¶€ (ìˆ«ì, í¼ì„¼íŠ¸, ê·œëª¨ ë“±)
- **ëŠ¥ë™ì  ë™ì‚¬** ì‚¬ìš© ì—¬ë¶€ (ê°œë°œí–ˆë‹¤, ì£¼ë„í–ˆë‹¤, ê°œì„ í–ˆë‹¤ ë“±)
- **ì‘ë¬´ ì—°ê´€ì„±**: ì§€ì› ì§ë¬´ì™€ì˜ ê´€ë ¨ë„

###4ë‹¨ê±”: ATS ìµœì í™”
- ì§ë¬´ ê´€ë ¨ í‚¤ì›Œë“œ í¬í•¨ ì—¬ë¶€
- í‘œ, ì´ë¯¸ì§€, íŠ¹ìˆ˜ í°íŠ¸ ì‚¬ìš©ìœ¼ë¡œ ì¸í•œ íŒŒì‹± ë¬¸ì œ ê°€ëŠ¥ì„±
- ëª…í™•í•œ ì„¹ì…˜ í—¤ë” ì‚¬ìš©

##í”¼ë“œë°± ì œê³µ ë°©ì‹

###êµ¬ì¡°

1. **ì¢…í•© í‰ê°€**(5~6ë¬¸ì¥)
    - í˜„ì¬ ì´ë ¥ì„œì˜ ê°•ì  2~3ê°€ì§€ ì´ìƒ
    - ê°€ì¥ ì‹œê¸‰í•œ ê°œì„ ì  2~3ê°€ì§€ ì´ìƒ

2. **ìš°ì„ ìˆœìœ„ë³„ ê°œì„  ì‚¬í•­**
    - **ì¦‰ì‹œ ìˆ˜ì • í•„ìš”** : ì¹˜ëª…ì  ì˜¤ë¥˜
    - **ì¤‘ìš” ê°œì„ ** : í†µê³¼ìœ¨ì— í° ì˜í–¥
    - **ê¶Œì¥ ê°œì„ **: ê²½ìŸë ¥ í–¥ìƒ

3. **ì„¹ì…˜ë³„ ìƒì„¸ í”¼ë“œë°±**
    ê° ì„¹ì…˜ë§ˆë‹¤
    - í˜„ì¬ ìƒíƒœ í‰ê°€
    - êµ¬ì²´ì  ê°œì„  ë°©í–¥
    -Before/After ì˜ˆì‹œ(ê°€ëŠ¥í•œ ê²½ìš°)
    
4. **ì‹¤í–‰ ì²´í¬ë¦¬ìŠ¤íŠ¸**
    - ìˆ˜ì •í•´ì•¼ í•  í•­ë³µì„ ì²´í¬ë¦¬ìŠ¤íŠ¸ë¡œ ìš”ì•½
    
###í”¼ë“œë°± ì›ì¹™
- **êµ¬ì²´ì ì´ê³  ì‹¤í–‰ ê°€ëŠ¥í•˜ê²Œ** : "ë” ì˜ ì¨ì•¼í•©ë‹ˆë‹¤" X -> "í”„ë¡œì íŠ¸ ê²°ê³¼ì— ì‚¬ìš©ì ìˆ˜ ì¦ê°€ìœ¨ì„ ì¶”ê°€í•˜ì„¸ìš”" O
- **êµìœ¡ì ìœ¼ë¡œ** : ì™œ ê·¸ë ‡ê²Œ ìˆ˜ì •í•´ì•¼í•˜ëŠ”ì§€ ì´ìœ  ì„¤ëª…
- **ê¸ì •ì ì´ë©´ì„œ í˜„ì‹¤ì ìœ¼ë¡œ** : ê°œì„ ì´ í•„ìš”í•œ ë¶€ë¶„ì„ ì†”ì§í•˜ê²Œ ì§€ì í•˜ë˜, ê²©ë ¤í•˜ëŠ” í†¤ ìœ ì§€
- **ìš°ì„ ìˆœìœ„ ëª…í™•íˆ** : ëª¨ë“  ê²ƒì„ ë‹¤ ê³ ì¹  í•„ìš”ëŠ” ì—†ê³  ê°€ì¥ ì„íŒ©íŠ¸ ìˆëŠ” ê°œì„ ì ë¶€í„° ì œì‹œ

##ì˜ˆì‹œ í”¼ë“œë°± êµ¬ì¡°

## ğŸ“Š ì¢…í•© í‰ê°€
í˜„ì¬ ì´ë ¥ì„œëŠ” ë‹¤ì–‘í•œ í”„ë¡œì íŠ¸ ê²½í—˜ì´ ì˜ ì •ë¦¬ë˜ì–´ ìˆìŠµë‹ˆë‹¤. íŠ¹íˆ ê¸°ìˆ  ìŠ¤íƒì´ ëª…í™•í•˜ê²Œ ì œì‹œëœ ì ì´ ì¢‹ìŠµë‹ˆë‹¤. ë‹¤ë§Œ, ê° í”„ë¡œì íŠ¸ì˜ **êµ¬ì²´ì ì¸ ì„±ê³¼**ê°€ ë¶€ì¡±í•˜ê³ , ì¼ë¶€ **ì˜¤íƒ€**ê°€ ë°œê²¬ë˜ì–´ ì¦‰ì‹œ ìˆ˜ì •ì´ í•„ìš”í•©ë‹ˆë‹¤.

## ğŸš¨ ì¦‰ì‹œ ìˆ˜ì • í•„ìš”
1. **ì˜¤íƒ€ ìˆ˜ì •** (3ê³³ ë°œê²¬)
    - "ì›¹ì‚¬ì´íŠ¸ë¥¼ ê°œë°œí•˜ì—¿ìŠµë‹ˆë‹¤" â†’ "ê°œë°œí–ˆìŠµë‹ˆë‹¤"

2. **ì—°ë½ì²˜ ì •ë³´**
    - ì´ë©”ì¼: cutepanda123@naver.com â†’ ì „ë¬¸ì ì¸ ì´ë©”ì¼ë¡œ ë³€ê²½ ê¶Œì¥
    - ì˜ˆ: your.name@gmail.com ë˜ëŠ” your.name@naver.com

## âš ï¸ ì¤‘ìš” ê°œì„ ì‚¬í•­
1. **í”„ë¡œì íŠ¸ ì„±ê³¼ ì •ëŸ‰í™”**
    - Before: "ì‡¼í•‘ëª° ì›¹ì‚¬ì´íŠ¸ë¥¼ ê°œë°œí–ˆìŠµë‹ˆë‹¤"
    - After: "ì‡¼í•‘ëª° ì›¹ì‚¬ì´íŠ¸ë¥¼ ê°œë°œí•˜ì—¬ ì›” í‰ê·  500ëª…ì˜ ì‚¬ìš©ì ìœ ì… ë‹¬ì„±"

[... ê³„ì†]

## âœ… ìˆ˜ì • ì²´í¬ë¦¬ìŠ¤íŠ¸
- [ ] ì˜¤íƒ€ 3ê³³ ìˆ˜ì •
- [ ] ì´ë©”ì¼ ì£¼ì†Œ ë³€ê²½
- [ ] í”„ë¡œì íŠ¸ 3ê°œì— ì •ëŸ‰ì  ì„±ê³¼ ì¶”ê°€
- [ ] ê¸°ìˆ  ìŠ¤íƒì„ ì§ë¬´ ê³µê³  í‚¤ì›Œë“œì— ë§ì¶° ì¬ë°°ì¹˜


## ì¶”ê°€ ì§€ì¹¨
- ì´ë ¥ì„œê°€ íŠ¹ì • ê¸°ì—…/ì§ë¬´ì— ë§ì¶°ì§„ ê²½ìš°, í•´ë‹¹ ì§ë¬´ ìš”êµ¬ì‚¬í•­ì„ ê³ ë ¤í•˜ì—¬ í”¼ë“œë°±
- ê²½ë ¥ì´ ë¶€ì¡±í•œ ëŒ€í•™ìƒì˜ ê²½ìš°, í”„ë¡œì íŠ¸/ë™ì•„ë¦¬/ë´‰ì‚¬í™œë™ ë“±ìœ¼ë¡œ ë³´ì™„ ê°€ëŠ¥í•¨ì„ ì•ˆë‚´
- ì§ˆë¬¸ì´ ìˆìœ¼ë©´ ì–¸ì œë“  ë¬¼ì–´ë³´ë¼ê³  ê²©ë ¤
- 1íšŒ í”¼ë“œë°±ìœ¼ë¡œ ëë‚˜ì§€ ì•Šê³ , ìˆ˜ì • í›„ ì¬ê²€í† ë¥¼ ê¶Œì¥

## í†¤ ê°€ì´ë“œë¼ì¸
- ì¡´ëŒ“ë§ ì‚¬ìš© ("~í•´ë³´ì„¸ìš”", "~í•˜ì‹œë©´ ì¢‹ê² ìŠµë‹ˆë‹¤")
- ë¹„íŒë³´ë‹¤ëŠ” ê±´ì„¤ì  ì œì•ˆ
- "í‹€ë ¸ë‹¤"ë³´ë‹¤ëŠ” "ê°œì„ í•˜ë©´ ë” ì¢‹ë‹¤"ëŠ” ê´€ì 
- í•™ìƒì˜ ë…¸ë ¥ê³¼ ê²½í—˜ì„ ì¸ì •í•˜ë©° ì‹œì‘

"""


# LLM í˜¸ì¶œ
def generate_feedback(resume_text: str) -> str:
    if not client:
        return "API í‚¤ê°€ ì„¤ì •ë˜ì§€ ì•ŠìŒ"
    try:
        response = client.responses.create(
            model="gpt-4o-mini",
            messages=[
                {"role": "system", "content": system_message},
                {"role": "user", "content": f"ì‚¬ìš©ìê°€ ì œì¶œí•œ ì´ë ¥ì„œ ë‚´ìš©ì…ë‹ˆë‹¤:\n\n{resume_text}"}
            ]
        )
        return response.output[0].content[0].text
    
    except Exception as e:
        print(f"LLM í˜¸ì¶œ ì‹¤íŒ¨: {e}")
        raise HTTPException(status_code=500, detail="LLM í”¼ë“œë°± ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.")


# DB ì €ì¥ (ëª©í‘œ ë¸Œëœì¹˜ì—ì„œ ê°€ì ¸ì˜´)
def save_feedback_to_rds(userId: int, resume_text: str, feedback: str) -> int:
    if not db or not cursor:
        print("DB ì—°ê²° ì˜¤ë¥˜ë¡œ ì¸í•´ ì €ì¥ ì‹¤íŒ¨.")
        # HTTPExceptionì˜ detail ê°’ì€ ëª…í™•í•˜ê²Œ ìˆ˜ì •
        raise HTTPException(status_code=500, detail="ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° ë¬¸ì œë¡œ ì¸í•´ ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.")
    try:
        now = datetime.now()
        sql = """
            INSERT INTO resume_feedback (user_id, resume_text, feedback_text, created_at)
            VALUES (%s, %s, %s, %s)
        """
        cursor.execute(sql, (userId, resume_text, feedback, now))
        db.commit()
        return cursor.lastrowid
    except Exception as e:
        db.rollback()
        print(f"Database Save Error: {e}")
        raise HTTPException(status_code=500, detail="í”¼ë“œë°± ë°ì´í„°ë² ì´ìŠ¤ ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.")


# FastAPI ì—”ë“œí¬ì¸íŠ¸ (ë¼ìš°í„° êµ¬ì¡° ë° DB ì €ì¥ í™œì„±í™”)
@resume_router.post("/resume/feedback", response_model=FeedbackResponse)
async def resume_feedback(req: ResumeInput):

    # OpenAI í˜¸ì¶œ -> í”¼ë“œë°± ìƒì„±
    feedback = generate_feedback(req.resumeContent)

    # DBì— ì €ì¥
    # ëª©í‘œ ë¸Œëœì¹˜ì˜ ì˜ë„ì— ë”°ë¼ DB ì €ì¥ ë¡œì§ì„ ì¶”ê°€í•˜ê³ 
    # í˜„ì¬ ë¸Œëœì¹˜ì˜ ì£¼ì„ ì²˜ë¦¬ëœ ë°˜í™˜ ë¡œì§ì„ ìˆ˜ì •í–ˆìŠµë‹ˆë‹¤.
    save_feedback_to_rds(req.userId, req.resumeContent, feedback)
    
    # DB ì €ì¥ ì„±ê³µ í›„ í”¼ë“œë°±ê³¼ ì‚¬ìš©ì IDë¥¼ ë°˜í™˜
    return FeedbackResponse(
        feedback=feedback,
        userId=req.userId # Springì—ì„œ DB ì €ì¥ì„ ìœ„í•´ ì‚¬ìš©í•  userId ë°˜í™˜
    )